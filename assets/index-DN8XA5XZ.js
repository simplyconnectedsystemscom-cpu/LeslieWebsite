(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function n(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(s){if(s.ep)return;s.ep=!0;const r=n(s);fetch(s.href,r)}})();const W=document.getElementById("navbar");window.addEventListener("scroll",()=>{window.scrollY>50?W.classList.add("scrolled"):W.classList.remove("scrolled")});const se=document.querySelectorAll(".reveal"),re=(t,e)=>{t.forEach(n=>{n.isIntersecting&&n.target.classList.add("active")})},ae={threshold:.15,rootMargin:"0px 0px -50px 0px"},le=new IntersectionObserver(re,ae);se.forEach(t=>le.observe(t));console.log("Leslie Website Loaded");const F={apiBase:"/api"},R=[{name:"Rouge (CH5116)",hex:"#D70000"},{name:"Brique (C972)",hex:"#CB4154"},{name:"Bourgogne (C978)",hex:"#800020"},{name:"Wine (CH8264)",hex:"#722F37"},{name:"Framboise (CH5193)",hex:"#E30B5C"},{name:"Orange Brulé (CH8265)",hex:"#CC5500"},{name:"Honey (CH5212)",hex:"#EB9605"},{name:"Amber (C995)",hex:"#FFBF00"},{name:"Gold (C918)",hex:"#FFD700"},{name:"Vieil Or (CH1418)",hex:"#CFB53B"},{name:"Lime (CH5139)",hex:"#32CD32"},{name:"Sage (C930)",hex:"#9DC183"},{name:"Cactus (C953)",hex:"#5b6f55"},{name:"Sapin (CH5536)",hex:"#097969"},{name:"Olive foncé (C936)",hex:"#556B2F"},{name:"Forest (C905)",hex:"#0b6623"},{name:"Turquoise (CH1510)",hex:"#40E0D0"},{name:"Jeans (CH4271)",hex:"#5dade2"},{name:"Periwinkle (CH5067)",hex:"#CCCCFF"},{name:"Bleu (CH4272)",hex:"#0000FF"},{name:"Bleu Cobalt (CH4274)",hex:"#0047AB"},{name:"Royal (CH963)",hex:"#2b4f81"},{name:"Peacock (CH4616)",hex:"#007090"},{name:"Marine (CH1425)",hex:"#000080"},{name:"Mauve (CH5153)",hex:"#E0B0FF"},{name:"Plum (CH1732)",hex:"#DDA0DD"},{name:"Fuschia (CH5169)",hex:"#FF00FF"},{name:"Chocolat (C964)",hex:"#7B3F00"},{name:"Stone (CH8115)",hex:"#888c8d"},{name:"Gris foncé (CH271)",hex:"#555555"},{name:"Charcoal (CH4275)",hex:"#36454F"},{name:"Noir (CH83)",hex:"#111111"}],I=[{id:"none",name:"No Tzitzit",description:"Do not attach strings",image:null},{id:"white",name:"Standard White",description:"All white strings",image:"images/ashkenazi.png"},{id:"techelet",name:"Techelet (Blue)",description:"White with blue thread",image:"images/ashkenazi.png"},{id:"ashkenazi",name:"Ashkenazi Knot",description:"7-8-11-13 windings",image:"images/ashkenazi.png"},{id:"sephardic",name:"Sephardic Knot",description:"10-5-6-5 windings",image:"images/sephardic.png"},{id:"chabad",name:"Chabad (Ari Zal)",description:"Chulya groups 3-3-3",image:"images/chabad.png"},{id:"yemenite",name:"Yemenite (Rambam)",description:"Specialized 7-13 chulyot",image:"images/yemenite.png"},{id:"vilna",name:"Vilna Gaon",description:"Gra method 13 windings",image:"images/vilna.png"}],P=[{id:"none",name:"No Atara",text:"",meaning:""},{id:"blessing",name:"The Blessing (L'hit'atef)",text:"...אֲשֶׁר קִדְּשָׁנוּ בְּמִצְוֹתָיו וְצִוָּנוּ לְהִתְעַטֵּף בַּצִּיצִת",meaning:"...Who commanded us to wrap ourselves in Tzitzit"},{id:"shiviti",name:"Shiviti Hashem",text:"שִׁוִּיתִי יְהוָה לְנֶגְדִּי תָמִיד",meaning:"I have set the Lord always before me (Psalm 16:8)"},{id:"etz_chaim",name:"Etz Chaim (Tree of Life)",text:"עֵץ־חַיִּים הִיא לַמַּחֲזִיקִים בָּהּ",meaning:"It is a Tree of Life to those who hold fast to it (Proverbs 3:18)"},{id:"jerusalem",name:"Jerusalem Skyline",text:"אִם־אֶשְׁכָּחֵךְ יְרוּשָׁלָ‍ִם",meaning:"If I forget thee, O Jerusalem... (Psalm 137:5)"}],U={name:"Blanchi (CH101)",hex:"#F5F5F3"};let a={userId:null,userName:null,baseColor:U,stripePattern:[],activeStripeId:null,tzitzitType:I[0],ataraStyle:P[0],isBackView:!1},g,i,X,_,Z,A,D;function ce(){try{if(console.log("Initializing Tallit Configurator (Integration Mode v2.1)..."),g=document.getElementById("tc-canvas"),!g)throw new Error("Canvas element #tc-canvas not found");i=g.getContext("2d");const t=window.devicePixelRatio||1,e=g.getBoundingClientRect(),n=800,o=600;g.width=n*t,g.height=o*t,g.style.width=n+"px",g.style.height=o+"px",i.scale(t,t),g._logicalWidth=n,g._logicalHeight=o,X=document.getElementById("tc-zoneUsage"),_=document.getElementById("tc-stripeStack"),Z=document.getElementById("tc-stripeColorPicker"),A=document.getElementById("tc-ataraSelector"),D=document.getElementById("tc-designSummary"),console.log("DOM Bound. Context:",!!i),console.log("Rendering Canvas..."),v(),console.log("Rendering Controls..."),h(),console.log("Updating Summary..."),w(),typeof M=="function"&&M(),typeof q=="function"&&window.addEventListener("scroll",q),typeof j=="function"?j():console.warn("attachIntegrationListeners not found"),z("stripes"),console.log("Tallit Configurator Init Complete")}catch(t){console.error("CRITICAL INIT ERROR:",t)}}function v(){if(g||(g=document.getElementById("tc-canvas")),!g)return;i||(i=g.getContext("2d")),i||(i=g.getContext("2d"));const t=g._logicalWidth||800,e=g._logicalHeight||600;i.clearRect(0,0,t,e);const n=50,o=t-n*2,s=e-n*2,r=n,c=n;if(o<=0||s<=0)return;const l=a.baseColor&&a.baseColor.hex?a.baseColor.hex:"#FFFFFF";i.save(),i.fillStyle=l,i.fillStyle=l,i.fillRect(r,c,o,s),i.restore(),de(r,c,o,s),me(r,c,o,s),a.isBackView?ye(r,c,o,s):(pe(r,c,o),fe(r,c,o,s)),ge(r,c,o,s)}function de(t,e,n,o){i.fillStyle="rgba(0,0,0,0.03)";for(let s=0;s<n;s+=2)i.fillRect(t+s,e,1,o);for(let s=0;s<o;s+=2)i.fillRect(t,e+s,n,1)}function me(t,e,n,o){const c=n/60,l=t+5*c,p=t+n-5*c;let m=l;a.stripePattern.forEach(u=>{const y=u.width*c;u.type==="stripe"&&(i.fillStyle=u.color.hex,i.fillRect(m,e,y,o)),m+=y});let d=p;a.stripePattern.forEach(u=>{const y=u.width*c;d-=y,u.type==="stripe"&&(i.fillStyle=u.color.hex,i.fillRect(d,e,y,o))})}function pe(t,e,n){if(a.ataraStyle.id==="none")return;const o=n*.4,s=40,r=t+n/2-o/2,c=a.ataraStyle,l=15;i.beginPath(),i.moveTo(r,e+s/2),i.lineTo(r+l,e),i.lineTo(r+o-l,e),i.lineTo(r+o,e+s/2),i.lineTo(r+o-l,e+s),i.lineTo(r+l,e+s),i.closePath(),i.fillStyle="#F8F9FA",i.fill(),i.strokeStyle="#B0B0B0",i.lineWidth=2,i.stroke(),c.id==="jerusalem"&&ue(r,e,o,s),c.text&&(i.save(),i.fillStyle="#222",i.font="bold 16px serif",i.textAlign="center",i.textBaseline="middle",i.fillText(c.text,r+o/2,e+s/2),i.restore())}function ue(t,e,n,o){i.save(),i.fillStyle="rgba(212, 175, 55, 0.3)",i.beginPath(),i.moveTo(t,e+o);const s=20,r=n/s;for(let c=0;c<=s;c++){const l=t+c*r,p=(Math.sin(c*1.5)+1)*(o*.3)+5;i.lineTo(l,e+o-p)}i.lineTo(t+n,e+o),i.closePath(),i.fill(),i.restore()}function ge(t,e,n,o){const p=o/45,m=3*p,d=4.5*p,u=1*p,y=e+d,x=e+o-d;function T(f,b,S,C){i.beginPath(),i.moveTo(f,b),i.lineTo(S,C),i.strokeStyle="#000000",i.lineWidth=5,i.stroke(),i.beginPath(),i.moveTo(f,b),i.lineTo(S,C),i.strokeStyle="#FFFFFF",i.lineWidth=3,i.stroke();const H=S-f,N=C-b,ne=Math.sqrt(H*H+N*N),oe=Math.atan2(N,H),ie=10;i.save(),i.translate(f,b),i.rotate(oe),i.beginPath(),i.strokeStyle="#000000",i.lineWidth=1;for(let k=2;k<ne-2;k+=ie)i.moveTo(k,-1.5),i.lineTo(k+2,1.5);i.stroke(),i.restore()}for(let f=y;f<=x;f+=u)T(t,f,t-m,f),T(t+n,f,t+n+m,f)}function fe(t,e,n,o){a.tzitzitType.id,[{x:t+10,y:e+o-10},{x:t+n-10,y:e+o-10},{x:t+10,y:e+10},{x:t+n-10,y:e+10}].forEach(r=>{i.beginPath(),i.strokeStyle="#ddd",i.arc(r.x,r.y,4,0,2*Math.PI),i.stroke(),i.fillStyle="#111",i.fill(),K(r.x,r.y)})}function K(t,e){const n=a.tzitzitType.id;n!=="none"&&(n==="ashkenazi"?B(t,e):n==="sephardic"?ve(t,e):n==="techelet"?B(t,e,!0):n==="chabad"?be(t,e):n==="yemenite"?Ee(t,e):B(t,e))}function ye(t,e,n,o){const l=4.5*(o/45);[{x:t,y:e},{x:t+n-l,y:e},{x:t,y:e+o-l},{x:t+n-l,y:e+o-l}].forEach(m=>{i.fillStyle="#FFFFFF",i.shadowColor="rgba(0,0,0,0.1)",i.shadowBlur=5,i.fillRect(m.x,m.y,l,l),i.shadowBlur=0,i.strokeStyle="#E0E0E0",i.strokeRect(m.x,m.y,l,l);const d=20,u=45;let y=m.x===t?t+d:t+n-d,x=m.y===e?e+d:e+o-d,T=m.x===t?t+u:t+n-u,f=m.y===e?e+d:e+o-d;[y,T].forEach((b,S)=>{const C=S===0?x:f;i.beginPath(),i.arc(b,C,4,0,2*Math.PI),i.fillStyle="#333",i.fill()}),he(y,x,T,f)})}function he(t,e,n,o){i.beginPath(),i.strokeStyle="#DDD",i.lineWidth=2,i.moveTo(t,e),i.lineTo(n,o),i.stroke(),K(t,e)}function B(t,e,n=!1){let s=e;const r="#FDFDFD",c="#1a4a8a";L(t,e+45,80,n);const l=[7,8,11,13];E(t,s,4,r),s+=4,l.forEach((p,m)=>{const d=p*.8;if(n)i.fillStyle=m%2!==0?c:r,i.fillRect(t-2,s,4,d);else{i.fillStyle=r,i.fillRect(t-2,s,4,d),i.strokeStyle="#E0E0E0",i.lineWidth=.5;for(let u=0;u<d;u+=2)i.beginPath(),i.moveTo(t-2,s+u),i.lineTo(t+2,s+u),i.stroke()}s+=d,E(t,s,4,r),s+=4})}function ve(t,e){L(t,e+40,80,!1);let n=e;const o=4,s=[10,5,6,5];E(t,n,o,"#FFF"),n+=o,s.forEach(r=>{const c=r*.8;i.fillStyle="#FFF",i.fillRect(t-2,n,4,c),i.strokeStyle="#DDD",i.lineWidth=1;for(let l=0;l<c;l+=3)i.beginPath(),i.moveTo(t-2,n+l),i.lineTo(t+2,n+l+2),i.stroke();n+=c,E(t,n,o,"#FFF"),n+=o})}function be(t,e){L(t,e+40,80,!1);let n=e;const o=4;E(t,n,o,"#FFF"),n+=o;for(let s=0;s<4;s++){i.fillStyle="#FFF",i.fillRect(t-2,n,4,15),i.strokeStyle="#CCC";for(let c=1;c<3;c++){let l=n+15*(c/3);i.beginPath(),i.moveTo(t-2,l),i.lineTo(t+2,l),i.stroke()}n+=15,E(t,n,o,"#FFF"),n+=o}}function Ee(t,e){L(t,e+50,70,!1);let n=e;for(let o=0;o<7;o++)i.fillStyle="#FFF",i.fillRect(t-3,n,6,6),i.strokeStyle="#BBB",i.strokeRect(t-3,n,6,6),n+=8}function E(t,e,n,o){i.fillStyle=o,i.beginPath(),i.arc(t,e+n/2,n/1.5,0,Math.PI*2),i.fill(),i.strokeStyle="#CCC",i.stroke()}function L(t,e,n,o){const r="#F0F0F0",c="#1a4a8a";for(let l=0;l<8;l++){i.beginPath();const p=o&&(l===0||l===7);i.strokeStyle=p?c:r,i.lineWidth=1.5;const m=(Math.random()-.5)*5,d=t+(l-3.5)*8*.5+m;i.moveTo(t,e),i.bezierCurveTo(t,e+n/2,d,e+n*.8,d,e+n),i.stroke()}}function h(){a.stripePattern.length===0?_.innerHTML='<div class="empty-state">No stripes added yet.</div>':_.innerHTML=a.stripePattern.map(n=>'<div class="stripe-item '+(n.id===a.activeStripeId?"active":"")+'" data-id="'+n.id+'" tabindex="0" role="button" aria-label="Select Stripe '+n.width+' inch"><div style="display: flex; align-items: center; gap: 10px;"><span>'+n.width+'" '+n.type+"</span>"+(n.type==="stripe"?'<div style="width: 16px; height: 16px; border-radius: 50%; background: '+n.color.hex+'; border: 1px solid #999;" title="'+n.color.name+'"></div>':"")+'</div><div class="delete-btn" data-delete-id="'+n.id+'" title="Delete Stripe" tabindex="0" role="button">✕</div></div>').join("");const t=a.stripePattern.reduce((n,o)=>n+o.width,0);X.innerText=`${t.toFixed(2)}" / 12"`,Z.innerHTML=R.map(n=>`
        <div class="color-swatch" style="background:${n.hex}" data-name="${n.name}"></div>
    `).join(""),A&&(A.innerHTML=P.map(n=>`
            <div class="tzitzit-card ${a.ataraStyle.id===n.id?"selected":""}" 
                 data-id="${n.id}"
                 role="button"
                 tabindex="0"
                 style="min-width: 220px;">
                <div class="tz-image" style="display:flex; align-items:center; justify-content:center; height:80px; margin-bottom:0.5rem; background:#f5f5f5; border-radius:4px;">
                     <span style="font-family:serif; font-size:1.4rem; color:${n.text?"#000":"#ccc"}; direction:${n.text?"rtl":"ltr"}; padding:0.5rem;">${n.text||"No Atara"}</span>
                </div>
                <h4>${n.name}</h4>
                <p style="font-size:0.75rem; color:#666;">${n.meaning}</p>
            </div>
        `).join(""));const e=document.getElementById("tc-tzitzitGallery");e&&(e.innerHTML=I.map(n=>{const o=n.image&&n.image.length>5;return`
            <div class="tzitzit-card ${a.tzitzitType.id===n.id?"selected":""}" 
                 data-id="${n.id}"
                 role="button"
                 tabindex="0">
                <div class="tz-image">
                    ${o?`<img src="${n.image}" alt="${n.id}" loading="lazy" 
                              style="cursor: default;">`:`<div style="height:120px; display:flex; align-items:center; justify-content:center; background:#f5f5f5; border-radius:4px; color:#999; font-style:italic;">${n.name}</div>`}
                </div>
                <h4>${n.name}</h4>
                <p>${n.description}</p>
            </div>
            `}).join("")),Te(),we()}function Te(){const t=document.getElementById("row-stripes"),e=document.getElementById("row-spaces"),n=document.getElementById("btn-done-selecting");if(!t||!e)return;const o=a.stripePattern.length>0?a.stripePattern[a.stripePattern.length-1]:null,s=document.getElementById("tc-colorPrompt"),r=document.getElementById("tc-stripeColorPicker")?.parentElement;a.pickingColor?(t.style.display="none",e.style.display="none",s&&(s.innerText="Pick Color for this Stripe",s.style.color="#d4af37",s.style.fontWeight="bold"),r&&(r.style.border="1px solid #d4af37",r.style.borderRadius="8px",r.style.padding="10px",r.style.background="rgba(212, 175, 55, 0.1)")):(s&&(s.innerText="Select Stripe Color:",s.style.color="",s.style.fontWeight="normal"),r&&(r.style.border="none",r.style.background="transparent",r.style.padding="0"),o&&o.type==="stripe"?(t.style.display="none",t.style.pointerEvents="none",e.style.display="flex",e.style.opacity="1",e.style.pointerEvents="auto"):(t.style.display="flex",t.style.opacity="1",t.style.pointerEvents="auto",e.style.display="none",e.style.opacity="0",e.style.pointerEvents="none"));let c=!a.pickingColor&&o&&o.type==="stripe";a.pickingColor&&(c=!1),n&&(c?(n.disabled=!1,n.style.opacity="1",n.style.pointerEvents="auto",n.style.cursor="pointer",n.style.borderColor="#d4af37",n.style.color="#d4af37"):(n.disabled=!0,n.style.opacity="0.3",n.style.pointerEvents="none",n.style.cursor="not-allowed",n.style.borderColor="#666",n.style.color="#666"),n.onclick=()=>{const l=a.stripePattern.length>0?a.stripePattern[a.stripePattern.length-1]:null;if(l&&l.type==="stripe"){const p=document.getElementById("stripeContinuePrompt");p&&p.remove(),["tzitzit-selection-area","atara-selection-area","final-options-area"].forEach(m=>{const d=document.getElementById(m);d&&(d.style.display="block",d.style.opacity="0",d.style.transition="opacity 0.6s ease",setTimeout(()=>d.style.opacity="1",10))}),setTimeout(()=>{document.getElementById("tzitzit-selection-area")?.scrollIntoView({behavior:"smooth",block:"center"})},100)}})}function Se(){const n=a.stripePattern.reduce((s,r)=>s+r.width,0);let o=0;return a.stripePattern.forEach(s=>{const r=s.threads||Math.round(s.width/.09375);o+=r}),{width:60,height:45,totalPatternWidth:n.toFixed(2),threadCount:`${o} Threads`}}function Ce(){const t=new Map;return a.stripePattern.forEach(e=>{if(e.type==="stripe"){const n=e.color.name,o=e.threads||Math.round(e.width/.09375);t.has(n)||t.set(n,{color:e.color,count:0}),t.get(n).count+=o}}),Array.from(t.values())}function w(){if(!D)return;const t=Se(),e=Ce();let n="";e.length>0?n=`
        <div style="margin-top: 0.5rem;">
          <strong>Thread Counts by Color:</strong>
          <div style="margin-top: 0.3rem; display: flex; flex-direction: column; gap: 0.3rem;">
            ${e.map(o=>`
              <div style="display: flex; align-items: center; gap: 0.6rem;">
                <div style="width: 14px; height: 14px; background-color: ${o.color.hex}; border: 1px solid #666; border-radius: 50%;"></div>
                <small style="opacity: 0.9;">${o.color.name} — <strong>${o.count} Threads</strong></small>
              </div>
            `).join("")}
          </div>
        </div>
      `:n='<small style="opacity: 0.5; display: block; margin-top: 0.5rem;">No stripes added yet.</small>',D.innerHTML=`
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div>
              <strong>Base:</strong> ${a.baseColor.name} <br>
              <strong>Style:</strong> ${a.tzitzitType.name} <br>
              <strong>Atara:</strong> ${a.ataraStyle.name} <br>
              ${a.ataraStyle.id!=="none"?`<small style="opacity: 0.7; font-style: italic;">${a.ataraStyle.meaning}</small><br>`:""}
              
              <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 0.5rem 0;">
              <strong>Proportions:</strong> <br>
              <small>Landscape (${t.width}" x ${t.height}")</small><br>
              <small>Pattern Width: ${t.totalPatternWidth}"</small><br>
            </div>
            <div>
               ${n}
               <div style="margin-top: 1rem;">
                  <strong>Total Threads:</strong> <br>
                  <small>${t.threadCount}</small>
               </div>
            </div>
          </div>
      `}function we(){document.querySelectorAll("#tc-stripeStack .stripe-item").forEach(r=>{const c=l=>{l.target.classList.contains("delete-btn")||(a.activeStripeId=parseFloat(r.dataset.id),h(),setTimeout(O,50))};r.onclick=c,r.addEventListener("keydown",l=>{(l.key==="Enter"||l.key===" ")&&(l.preventDefault(),c(l))})}),document.querySelectorAll("[data-delete-id]").forEach(r=>{const c=l=>{l.stopPropagation();const p=parseFloat(r.dataset.deleteId);a.stripePattern=a.stripePattern.filter(d=>d.id!==p),["stripeEditPrompt","stripeContinuePrompt","spaceNextPrompt"].forEach(d=>{const u=document.getElementById(d);u&&u.remove()}),h(),v()};r.onclick=c,r.addEventListener("keydown",l=>{(l.key==="Enter"||l.key===" ")&&(l.preventDefault(),c(l))})}),document.querySelectorAll(".color-swatch").forEach(r=>{r.onclick=()=>{const c=r.dataset.name,l=R.find(m=>m.name===c);if(window.gtag&&window.gtag("event","select_content",{content_type:"stripe_color",item_id:c}),a.activeStripeId&&a.stripePattern.length>0){const m=a.stripePattern.find(d=>d.id===a.activeStripeId);m&&m.type==="stripe"&&(m.color=l)}a.pickingColor=!1;const p=document.getElementById("stripeEditPrompt");p&&p.remove(),setTimeout(ke,300),h(),v()}});const t=document.getElementById("btn-done-selecting");t&&(t.onclick=()=>{z("tzitzit"),setTimeout(ze,600)});const e=document.getElementById("tc-tzitzitGallery");e&&e.querySelectorAll(".tzitzit-card").forEach(r=>{r.onclick=c=>{if(c.target.tagName==="IMG")return;const l=r.dataset.id;a.tzitzitType=I.find(m=>m.id===l),window.gtag&&window.gtag("event","select_content",{content_type:"tzitzit",item_id:l});const p=document.getElementById("tzitzitPrompt");p&&p.remove(),setTimeout(Fe,300),h(),v(),w(),l!=="none"&&z("atara")}});const n=document.getElementById("tc-ataraSelector");n&&n.querySelectorAll(".tzitzit-card").forEach(r=>{r.onclick=()=>{const c=r.dataset.id;a.ataraStyle=P.find(p=>p.id===c),window.gtag&&window.gtag("event","select_content",{content_type:"atara",item_id:c});const l=document.getElementById("ataraPrompt");l&&l.remove(),h(),v(),h(),v(),w(),te(),z("final")}});const o=document.getElementById("tc-btn-save-design");o&&(o.onclick=$);const s=document.getElementById("tc-btn-save-download");s&&(s.onclick=async()=>{await $(),Ie()})}function Ie(){const t=document.getElementById("tc-canvas");if(!t)return;const e=document.createElement("a");e.download=`Tallit_Design_${new Date().getTime()}.png`,e.href=t.toDataURL("image/png"),document.body.appendChild(e),e.click(),document.body.removeChild(e)}function M(){if(document.getElementById("namePathPrompt"))return;const t=document.createElement("div");t.id="namePathPrompt",t.innerText="Enter Name";const e=document.getElementById("tc-customerName");e&&e.parentElement&&(e.parentElement.style.position="relative",e.parentElement.appendChild(t),t.style.top="120%",t.style.left="0")}let G=!1;function q(){if(G||a.userName)return;const t=document.getElementById("tc-customerName");if(!t)return;const e=t.getBoundingClientRect();e.top>=0&&e.bottom<=window.innerHeight&&(document.getElementById("namePathPrompt")?.classList.add("visible"),G=!0)}function V(){document.getElementById("namePathPrompt")?.classList.remove("visible")}function j(){document.querySelectorAll(".btn-add-stripe").forEach(s=>{s.onclick=()=>Y("stripe",parseFloat(s.dataset.size))}),document.querySelectorAll(".btn-add-space").forEach(s=>{s.onclick=()=>Y("space",parseFloat(s.dataset.size))});const t=document.getElementById("tc-flipViewBtn");t&&(t.onclick=()=>{a.isBackView=!a.isBackView,t.innerText=a.isBackView?"View Front":"View Back",v()});const e=document.getElementById("tc-saveBtn");e&&(e.onclick=$);const n=document.getElementById("tc-customerName");n&&(n.addEventListener("input",V),n.addEventListener("keydown",s=>{s.key==="Enter"&&(s.preventDefault(),n.blur())}),n.onblur=()=>{n.value&&n.value!==a.userName&&(V(),Q(n.value),setTimeout(J,500))});const o=document.getElementById("tc-btn-new-design");o&&(o.onclick=()=>{Pe()})}function Pe(){window.gtag&&window.gtag("event","reset_design",{event_category:"tallit_configurator"}),a.stripePattern=[],a.activeStripeId=null,a.baseColor=U,a.tzitzitType=I[0],a.ataraStyle=P[0],a.isBackView=!1,a.pickingColor=!1,["stripeEditPrompt","stripeContinuePrompt","stripeBuilderPrompt","doneValuesPrompt","spaceNextPrompt","tzitzitPrompt","ataraPrompt"].forEach(o=>{const s=document.getElementById(o);s&&s.remove()}),setTimeout(J,300),document.getElementById("row-stripes").style.display="flex",document.getElementById("row-stripes").style.pointerEvents="auto",document.getElementById("row-spaces").style.display="none",["tzitzit-selection-area","atara-selection-area","final-options-area"].forEach(o=>{const s=document.getElementById(o);s&&(s.style.display="none")});const t=document.getElementById("btn-done-selecting");t&&(t.style.display="inline-block",t.disabled=!0,t.style.opacity="0.3",t.style.pointerEvents="none");const e=document.getElementById("tc-colorPrompt");e&&(e.innerText="Select Stripe Color:",e.style.color="",e.style.fontWeight="normal");const n=document.getElementById("tc-stripeColorPicker")?.parentElement;n&&(n.style.border="none",n.style.background="transparent",n.style.padding="0"),_e(),v(),h(),w(),setTimeout(O,100)}function J(){if(document.getElementById("stripeBuilderPrompt"))return;const t=document.querySelector(".builder-controls");if(!t)return;const e=document.createElement("div");e.id="stripeBuilderPrompt",e.innerText="Now, click a button to add your first stripe!",e.className="walkthrough-tooltip",t.style.position="relative",t.appendChild(e),e.style.top="-80px",e.style.left="70%",e.style.transform="translate(-50%, -100%)",e.style.width="200px",setTimeout(()=>e.classList.add("visible"),50),t.querySelectorAll("button").forEach(o=>{o.addEventListener("click",()=>{e.classList.remove("visible"),setTimeout(()=>e.remove(),500)},{once:!0})})}function Y(t,e){if(a.stripePattern.reduce((s,r)=>s+r.width,0)+e>12)return alert("Zone limit reached (12 inches)");const o={id:Math.random(),type:t,width:e,color:R[3]};a.stripePattern.push(o),a.activeStripeId=o.id,window.gtag&&window.gtag("event","design_interaction",{event_category:"tallit_configurator",action:"add_"+t,label:e+" inch"}),t==="stripe"&&(a.pickingColor=!0),["stripeEditPrompt","stripeContinuePrompt","stripeBuilderPrompt","doneValuesPrompt","spaceNextPrompt"].forEach(s=>{const r=document.getElementById(s);r&&r.remove()}),setTimeout(t==="stripe"?xe:Be,300),h(),v(),t==="stripe"&&setTimeout(O,300)}function xe(){if(document.getElementById("doneValuesPrompt"))return;const t=document.getElementById("btn-done-selecting");if(!t||t.disabled)return;const e=document.createElement("div");e.id="doneValuesPrompt",e.innerText="Click here when done selecting stripes",e.className="walkthrough-tooltip",t.parentElement.style.position="relative",t.parentElement.appendChild(e),e.style.top="-50px",e.style.left="50%",e.style.transform="translate(-50%, 0)",e.style.width="180px",setTimeout(()=>e.classList.add("visible"),50),setTimeout(()=>{e.classList.remove("visible"),setTimeout(()=>e.remove(),500)},4e3)}function O(){const t=document.getElementById("tc-stripeStack"),n=t?t.querySelector(".stripe-item.active"):null;if(!n){const r=document.getElementById("stripeEditPrompt");r&&r.remove();return}let o=document.getElementById("stripeEditPrompt");if(!o){o=document.createElement("div"),o.id="stripeEditPrompt",o.className="walkthrough-tooltip",document.body.appendChild(o),setTimeout(()=>o.classList.add("visible"),50);const r=()=>{o.classList.remove("visible"),setTimeout(()=>o.remove(),500)};setTimeout(()=>{document.addEventListener("click",r,{once:!0})},100)}o.innerText="Pick Color or Delete Stripe",(()=>{const r=n.getBoundingClientRect(),c=window.pageYOffset||document.documentElement.scrollTop,l=window.pageXOffset||document.documentElement.scrollLeft;o.style.top=`${r.top+c-70}px`,o.style.left=`${r.left+l+r.width/2}px`,o.style.transform="translate(-50%, 0)"})(),setTimeout(()=>o.classList.add("visible"),50)}function ke(){const t=document.getElementById("tzitzit-selection-area");if(t&&t.style.display!=="none"||a.stripePattern.length===0)return;const e=document.getElementById("stripeContinuePrompt");e&&e.remove();const n=document.querySelector(".builder-controls");if(!n)return;const o=document.createElement("div");o.id="stripeContinuePrompt",o.className="walkthrough-tooltip",o.style.minWidth="250px",o.innerHTML='<div style="margin-bottom: 0;"><strong>Great Choice!</strong><br>Now select a <strong>Space</strong>, <strong>Delete</strong> this stripe, or click <strong>Done Selecting</strong> below.</div>',n.style.position="relative",n.appendChild(o),o.style.top="-110px",o.style.left="50%",o.style.transform="translateX(-50%)",setTimeout(()=>o.classList.add("visible"),50)}function Be(){if(document.getElementById("spaceNextPrompt"))return;const t=document.querySelector(".builder-controls");if(!t)return;const e=document.createElement("div");e.id="spaceNextPrompt",e.className="walkthrough-tooltip",e.style.minWidth="250px",e.style.top="-110px",e.style.left="50%",e.style.transform="translateX(-50%)",e.innerHTML='<div style="margin-bottom: 0;"><strong>Space Added!</strong><br>Select another <strong>Stripe</strong> or <strong>Delete</strong> the space.</div>',t.style.position="relative",t.appendChild(e),setTimeout(()=>e.classList.add("visible"),50)}function z(t){const e=document.querySelector(".builder-controls"),n=document.getElementById("tzitzit-selection-area"),o=document.getElementById("atara-selection-area"),s=document.getElementById("final-options-area"),r=(c,l)=>{c&&(c.style.display=l)};t==="stripes"?(r(e,"block"),r(n,"none"),r(o,"none"),r(s,"none")):t==="tzitzit"?(r(n,"block"),n?.scrollIntoView({behavior:"smooth",block:"nearest"})):t==="atara"?(r(o,"block"),o?.scrollIntoView({behavior:"smooth",block:"nearest"})):t==="final"&&(r(s,"block"),s?.scrollIntoView({behavior:"smooth",block:"nearest"}))}function ze(){if(document.getElementById("tzitzitPrompt"))return;const t=document.getElementById("tzitzit-selection-area");if(!t)return;const e=document.createElement("div");e.id="tzitzitPrompt",e.className="walkthrough-tooltip",e.style.minWidth="250px",e.style.top="-60px",e.style.left="50%",e.style.transform="translateX(-50%)",e.innerHTML='<div style="margin-bottom: 0;"><strong>Next Step</strong><br>Select your <strong>Tzitzit</strong> style.</div>',t.style.position="relative",t.appendChild(e),setTimeout(()=>e.classList.add("visible"),50)}function Fe(){if(document.getElementById("ataraPrompt"))return;const t=document.getElementById("atara-selection-area");if(!t)return;const e=document.createElement("div");e.id="ataraPrompt",e.className="walkthrough-tooltip",e.style.minWidth="250px",e.style.top="-60px",e.style.left="50%",e.style.transform="translateX(-50%)",e.innerHTML='<div style="margin-bottom: 0;"><strong>Final Polish</strong><br>Select an <strong>Atara</strong> to complete your design.</div>',t.style.position="relative",t.appendChild(e),setTimeout(()=>e.classList.add("visible"),50)}async function Q(t){if(t)try{const n=await(await fetch(`${F.apiBase}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t})})).json();n.user&&(a.userId=n.user.id,a.userName=n.user.name,window.gtag&&window.gtag("event","login",{method:"name_entry"}),alert(`Welcome back, ${a.userName}!`),ee(a.userId))}catch(e){console.error(e)}}async function $(){if(!a.userId){const n=prompt("Please enter your name to login:");if(n)await Q(n);else return}const t=prompt("Enter a name for this design (e.g., 'Holiday Tallit'):","My Custom Tallit");if(!t)return;const e={baseColor:a.baseColor,stripePattern:a.stripePattern,tzitzitType:a.tzitzitType,ataraStyle:a.ataraStyle};try{await fetch(`${F.apiBase}/designs`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:a.userId,designData:e,designName:t})}),window.gtag&&window.gtag("event","save_design",{event_category:"tallit_configurator",design_name:t}),alert("Design Saved Successfully!"),ee(a.userId)}catch{alert("Save failed")}}async function Le(){try{const e=await(await fetch(`${F.apiBase}/stats`)).json();alert(`Total Users: ${e.totalUsers}
Designs: ${e.totalDesigns}
Top Color: ${e.popularColor}
Top Tzitzit: ${e.popularTzitzit}`)}catch{alert("Stats Error")}}async function ee(t){try{const n=await(await fetch(`${F.apiBase}/designs/${t}`)).json();He(n)}catch(e){console.error("Load Error:",e)}}function He(t){const e=document.getElementById("tc-saved-designs-list");if(e){if(t.length===0){e.style.display="none";return}e.style.display="block",e.innerHTML=`
        <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 4px; margin-top: 5px;">
            <strong style="color: #d4af37;">Saved Designs:</strong>
            <ul style="list-style: none; padding: 0; margin-top: 5px; max-height: 100px; overflow-y: auto;">
                ${t.map(n=>`
                    <li style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; padding-bottom: 4px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <span style="opacity: 0.9;">${n.designName||"Untitled"} <small style="opacity:0.5;">(${new Date(n.timestamp).toLocaleDateString()})</small></span>
                        <button onclick="window.restoreDesign('${n.id}')" style="background: transparent; border: 1px solid #aaa; color: #fff; cursor: pointer; border-radius: 3px; font-size: 0.7rem; padding: 2px 6px;">Load</button>
                    </li>
                `).join("")}
            </ul>
        </div>
    `,window.restoreDesign=n=>{const o=t.find(s=>s.id===n);o&&Ne(o.data)}}}function Ne(t){if(t){if(a.stripePattern=t.stripePattern||[],t.baseColor&&(a.baseColor=t.baseColor),t.tzitzitType){const e=I.find(n=>n.id===t.tzitzitType.id);e&&(a.tzitzitType=e)}if(t.ataraStyle){const e=P.find(n=>n.id===t.ataraStyle.id);e&&(a.ataraStyle=e)}v(),h(),w(),a.stripePattern.length>0&&(document.getElementById("row-stripes").style.display="none",document.getElementById("tzitzit-selection-area").style.display="block",a.tzitzitType.id!=="none"&&(document.getElementById("atara-selection-area").style.display="block"),document.getElementById("final-options-area").style.display="block",a.ataraStyle&&a.ataraStyle.id!=="none"&&te()),alert("Design Loaded!")}}window.openLightbox=function(t,e,n){t&&t.stopPropagation();let o=document.getElementById("tc-image-lightbox");o||(o=document.createElement("div"),o.id="tc-image-lightbox",o.className="lightbox-overlay",o.onclick=window.closeLightbox,o.innerHTML=`
            <div class="lightbox-content" onclick="event.stopPropagation()">
                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:1rem;">
                    <h3 id="lb-title" style="margin:0; color:#d4af37;"></h3>
                    <span class="lightbox-close" onclick="window.closeLightbox()" style="cursor:pointer; font-size:1.5rem; color:#fff;">×</span>
                </div>
                <img id="lb-image" src="" alt="Zoomed View" style="max-width:100%; max-height:80vh; object-fit:contain; border-radius:4px; background:white; padding:1rem;">
            </div>
        `,document.body.appendChild(o));const s=document.getElementById("lb-image");s&&(s.src=e);const r=document.getElementById("lb-title");r&&(r.innerText=n),o.style.display="flex",requestAnimationFrame(()=>o.classList.add("visible"))};window.closeLightbox=function(){const t=document.getElementById("tc-image-lightbox");t&&(t.classList.remove("visible"),setTimeout(()=>t.style.display="none",300))};function te(){const t=document.querySelector(".canvas-area"),e=document.getElementById("final-options-area");t&&e&&e.parentNode&&(e.parentNode.insertBefore(t,e),t.style.width="100%",t.style.marginBottom="2rem")}function _e(){const t=document.querySelector(".canvas-area"),e=document.querySelector(".designer-container");t&&e&&t.parentElement!==e&&(e.prepend(t),t.style.width="",t.style.marginBottom="")}window.showGlobalStats=Le;window.addEventListener("load",()=>{setTimeout(ce,100)});
